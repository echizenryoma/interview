## 传输层

### TCP/IP协议栈

![TCP/IP协议栈](/assets/tcp-ip-protocol-stack.svg)

最左边的网络应用tcpdump直接使用BPF (BSD 分组过滤器）或 DLPI（数据链路提供者接口）同数据链路层进行通信。ping使用ICMP协议。

### UDP

用户数据报协议（User Datagram Protocol）是无连接的，数据传输的单位是用户数据报，不保证提供可靠的交付，只能提供“尽最大努力交付”。

#### UDP报头

<table>
<tbody style="text-align: center">
<tr>
<th>位偏移</th>
<th colspan="8">0-7</th>
<th colspan="8">8-15</th>
<th colspan="8">16-23</th>
<th colspan="8">24-31</th>
</tr>
<tr>
<th>0</th>
<td colspan="16">来源连接端口</td>
<td colspan="16">目的连接端口</td>
</tr>
<tr>
<th>32</th>
<td colspan="16">报文长度</td>
<td colspan="16">校验和</td>
</tr>
</tbody></table>

### TCP

传输控制协议（Transmission Control Protocol）：面向连接的，数据传输的单位是报文段，能够提供可靠的交付。

1. TCP是一种面向连接的协议，提供客户与服务器的连接。
2. TCP提供可靠性。当使用TCP向另一端发送数据时， 它要求对端返回一个确认。如果没有收到确认，TCP自动重传数据并等待更长时间。在数次重传失败后，TCP才放弃。
3. TCP通过给所发送数据的每一个字节关联一个序列号进行排序。UDP 提供不可靠的数据报传送不提供确认、 序列号、 超时重传等机制。
4. TCP 提供流量控制，而UDP 不提供流量控制。TCP 总是告诉对端它能够接收多少字节的数据，这称为**通告窗口**。该窗口在任何时刻都指出接收缓冲区中的可用空间， 从而确保发送端发送的数据不会溢出接收缓冲区。

### TCP和UDP区别

UDP与TCP的主要区别在于UDP**不一定提供**（但是可以自己实现）可靠的数据传输。

|  | TCP | UDP |
| :---: | :---: | :---: |
| 是否连接 | 面向连接 | 面向非连接 |
| 传输可靠性 | 应用层 | 不可靠的 |
| 应用场合 | 传输大量的数据 | 传输少量数据 |

TCP协议和UDP协议特性区别：

1. TCP协议在传送数据段的时候要给段标号；UDP协议不需要
2. TCP协议是可靠的；UDP协议是不可靠的
3. TCP协议是面向连接；UDP协议采用无连接
4. TCP协议负载较高，采用面向连接方式；UDP采用无连接方式
5. TCP协议的发送方要确认接收方是否收到数据段（3次握手协议）
6. TCP协议采用窗口技术和流控制

### 三次握手建立连接

1. 客户端向服务器发送一个SYN J
2. 服务器向客户端响应一个SYN K，并对SYN J进行确认ACK J+1
3. 客户端再向服务器发一个确认ACK K+1

![](/assets/tcp-3-way-handshake.svg)

### 四次挥手释放连接

建立一个连接需要三次握手，而终止一个连接要经过4次挥手。这由TCP的半关闭造成的。既然一个TCP连接是全双工，因此每个方向必须单独地进行关闭。

1. 某个应用进程首先调用close, 称这一端执行主动关闭。这一端的TCP于是发送一个FIN分节，表示数据发送完毕
2. 另一端接收到FIN分节之后，执行被动关闭，对这个FIN进行确认。它的接收也作为文件结束符传递给接收端应用进程，因为FIN的接收意味着应用进程在相应的连接上再也接收不到额外数据
3. 一段时间之后，接收到文件结束符的应用进程调用close关闭它的套接口。这导致它的TCP也发送一个FIN
4. 接收到这个FIN的原发送端TCP（即执行主动关闭的那一端）对它进行确认。

![](/assets/tcp-4-way-handshake.svg)

这样每个方向上都有一个FIN和ACK，所以一共需要四个分节。但是有时步骤1的FIN随数据一起发送；另外，执行被动关闭那一端的TCP在步骤2和3发出的ACK与FIN也可以合并成一个分节。

### 长连接

`短连接`：建立连接——数据传输——关闭连接...建立连接——数据传输——关闭连接
`长连接`：建立连接——数据传输...（保持连接）...数据传输——关闭连接

#### TCP保活功能
保活功能主要为服务器应用提供，服务器应用希望知道客户主机是否崩溃，从而可以代表客户使用资源。如果客户已经消失，使得服务器上保留一个半开放的连接，而服务器又在等待来自客户端的数据，则服务器将应远等待客户端的数据，保活功能就是试图在服务器端检测到这种半开放的连接。

